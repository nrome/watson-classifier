<!DOCTYPE html>
<html>
	<head>
		<title>WEA Demonstration</title>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script>
			function updateScroll(){
				var element = document.getElementById("chat");
				element.scrollTop = element.scrollHeight;
			}
		</script>
		<link href="/static/stylesheets/styles.css" rel="stylesheet">
	</head>
	<body onload=updateScroll()>
		<div class="container">
			<header>
				<h1>Partner Digitial Concierge...chat with Watson!</h1>
			</header>	
			<main class="chat">
				<div id="chat">
					{% for post in posts %}
					<div class='{{post.style}}'>
						<div class='messages'>
							<p>{% autoescape false %}{{post.text}}{% endautoescape %}</p>
							<time datetime='{{post.datetime}}'>{{post.name}} â€¢ {{post.datetime}}</time>
						</div>
					</div>
					{% endfor %}
				</div>
				<!-- Additions for TTS & STT -->
				<p><input id="voice" type="checkbox" /> Use voice</p>
				<form class="chat--input" action='.' method='POST'>
					<input autofocus id="response-input" name='response-input' placeholder="Ask IBM a question..."></input>
					<button>Send</button>
				</form>
			</main>
			<aside>
				<section class="faq">
					<!--<h3>Form &#38; FAQ</h3>-->
					<h3>The "side view mirror"</h3>
					<div>{% autoescape false %}{{form}}{% endautoescape %}</div>
				</section>			
				<section class="tips">
					<!--<h3>Tips</h3>-->
					<h3> </h3>
					<div>{% autoescape false %}{{tips}}{% endautoescape %}</div>
				</section>
			</aside>
			<footer>
				<p><b>IBM Confidential - INTERNAL USE ONLY</b> &#169; 2016 IBM. All rights reserved.</p>
			</footer>
		</div>
		<!-- Additions for TTS & STT -->
		<div id="what-to-say" style="display:none">{% autoescape false %}{{posts[-1].text}}{% endautoescape %}</div>
		<script src="/static/scripts/watson-speech.min.js"></script>
		<script>
			var ttsToken = "{{tts_token}}";
			var sttToken = "{{stt_token}}";
		//	records microphone input to
			function record() {
			//	$micButton.addClass('active');
				return WatsonSpeech.SpeechToText.recognizeMicrophone({
					token: sttToken,
				//	automatically stop at first pause
					continuous: false,
					outputElement: '#response-input',
				//	don't add capitalization and periods to the input text
					format: false
				//	if using ajax to submit audio, this makes firefox only ask for mic permission once
				//	keepMicrophone: navigator.userAgent.indexOf('Firefox') > 0
				})
				.promise()
				.then(function() {
					document.querySelector('form.chat--input').submit();
				})
				.catch(console.log);
			}
			var audio;
			function say(text) {
				if (audio) {
					audio.pause();
				}
				return new Promise(function(resolve, reject){
					audio = WatsonSpeech.TextToSpeech.synthesize({
						text: text,
						token: ttsToken,
						voice: 'en-US_AllisonVoice'
					});
					audio.addEventListener('ended', resolve);
					audio.addEventListener('error', reject);
				});
			}
		//	control voice with a checkbox, remember it between pageviews
			var voiceCheckbox = document.querySelector('#voice');
		//	default to false, switch it to !== 'false' to default it to true
			voiceCheckbox.checked = localStorage.usevoice === 'true';
			function initVoice() {
				if (voiceCheckbox.checked) {
					say(document.querySelector('#what-to-say').textContent).then(record);
				} else if (audio) {
					audio.pause();
				}
				localStorage.usevoice = voiceCheckbox.checked;
			}
			voiceCheckbox.onclick = initVoice;
			initVoice();
		</script>
	</body>
</html>